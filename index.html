<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Options Scanner</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg:           var(--tg-theme-bg-color,           #1c1c1e);
            --text:         var(--tg-theme-text-color,         #ffffff);
            --hint:         var(--tg-theme-hint-color,         #8e8e93);
            --btn:          var(--tg-theme-button-color,       #2481cc);
            --btn-text:     var(--tg-theme-button-text-color,  #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #2c2c2e);
            --sep:          rgba(255,255,255,0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 16px 16px 24px;
            min-height: 100vh;
        }

        h2 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
            margin-bottom: 20px;
        }

        /* â”€â”€ Section â”€â”€ */
        .section { margin-bottom: 20px; }

        .section-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--hint);
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-bottom: 8px;
            padding-left: 4px;
        }

        /* â”€â”€ Toggle SHORT / MID â”€â”€ */
        .toggle-group {
            display: flex;
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 3px;
            gap: 3px;
        }

        .toggle-btn {
            flex: 1;
            padding: 9px 8px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            background: transparent;
            color: var(--hint);
            transition: background 0.18s, color 0.18s;
        }

        .toggle-btn.active {
            background: var(--btn);
            color: var(--btn-text);
        }

        /* â”€â”€ Grid buttons â”€â”€ */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .chip {
            padding: 11px 8px;
            border: 2px solid var(--secondary-bg);
            border-radius: 12px;
            background: var(--secondary-bg);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            transition: border-color 0.15s, background 0.15s, color 0.15s;
            text-align: center;
            line-height: 1.3;
        }

        .chip.active {
            border-color: var(--btn);
            background: var(--btn);
            color: var(--btn-text);
        }

        .chip:disabled,
        .chip[data-disabled] {
            opacity: 0.35;
            cursor: default;
        }

        /* â”€â”€ Date chips â”€â”€ */
        .date-chip {
            padding: 10px 8px;
        }

        .date-chip .date-day {
            font-weight: 700;
            font-size: 15px;
        }

        .date-chip .date-sub {
            font-size: 11px;
            color: var(--hint);
            margin-top: 2px;
        }

        .date-chip.active .date-sub {
            color: rgba(255,255,255,0.7);
        }

        /* â”€â”€ Placeholder â”€â”€ */
        .placeholder {
            font-size: 13px;
            color: var(--hint);
            padding: 12px 4px;
            text-align: center;
        }

        /* â”€â”€ Scan button â”€â”€ */
        #scan-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: var(--btn);
            color: var(--btn-text);
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 4px;
            transition: opacity 0.15s;
        }

        #scan-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        /* â”€â”€ Summary bar â”€â”€ */
        #summary {
            font-size: 13px;
            color: var(--hint);
            margin-bottom: 12px;
            min-height: 18px;
            padding-left: 4px;
        }
    </style>
</head>
<body>

<h2>âš™ï¸ ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</h2>

<!-- Term -->
<div class="section">
    <div class="section-label">Ğ¢Ğ¸Ğ¿ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸</div>
    <div class="toggle-group">
        <button class="toggle-btn active" id="btn-short" onclick="setTerm('SHORT')">ğŸ“… Short Term</button>
        <button class="toggle-btn"        id="btn-mid"   onclick="setTerm('MID')">ğŸ“† Mid Term</button>
    </div>
</div>

<!-- Min DTE -->
<div class="section">
    <div class="section-label">ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ DTE</div>
    <div id="min-grid" class="grid"></div>
</div>

<!-- Max DTE -->
<div class="section">
    <div class="section-label">ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ DTE</div>
    <div id="max-grid" class="grid"></div>
</div>

<!-- Expiration dates -->
<div class="section">
    <div class="section-label">Ğ”Ğ°Ñ‚Ğ° ÑĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ğ¸</div>
    <div id="dates-grid" class="grid"></div>
</div>

<!-- Summary + Scan -->
<div id="summary"></div>
<button id="scan-btn" onclick="startScan()" disabled>ğŸ” Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</button>

<script>
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

// â”€â”€ Options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SHORT_MIN = [3, 5, 7, 10];
const SHORT_MAX = [5, 7, 10, 14];
const MID_MIN   = [14, 21, 30, 45];
const MID_MAX   = [21, 30, 45, 60];

const MONTHS = ['', 'ÑĞ½Ğ²', 'Ñ„ĞµĞ²', 'Ğ¼Ğ°Ñ€', 'Ğ°Ğ¿Ñ€', 'Ğ¼Ğ°Ğ¹', 'Ğ¸ÑĞ½',
                    'Ğ¸ÑĞ»', 'Ğ°Ğ²Ğ³', 'ÑĞµĞ½', 'Ğ¾ĞºÑ‚', 'Ğ½Ğ¾Ñ', 'Ğ´ĞµĞº'];
const WDAYS  = ['Ğ²Ñ', 'Ğ¿Ğ½', 'Ğ²Ñ‚', 'ÑÑ€', 'Ñ‡Ñ‚', 'Ğ¿Ñ‚', 'ÑĞ±'];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let s = { term: 'SHORT', min_dte: null, max_dte: null, date: null };

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dteLabel(n) {
    if (n >= 11 && n <= 14) return `${n} Ğ´Ğ½ĞµĞ¹`;
    const r = n % 10;
    if (r === 1) return `${n} Ğ´ĞµĞ½ÑŒ`;
    if (r >= 2 && r <= 4) return `${n} Ğ´Ğ½Ñ`;
    return `${n} Ğ´Ğ½ĞµĞ¹`;
}

function getFridays(minDte, maxDte) {
    const today = new Date(); today.setHours(0,0,0,0);
    const cur   = new Date(today); cur.setDate(today.getDate() + minDte);
    const end   = new Date(today); end.setDate(today.getDate() + maxDte);
    while (cur.getDay() !== 5) cur.setDate(cur.getDate() + 1);
    const result = [];
    while (cur <= end) { result.push(new Date(cur)); cur.setDate(cur.getDate() + 7); }
    return result;
}

function isoDate(d) {
    return d.toISOString().split('T')[0];
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTerm(term) {
    s = { term, min_dte: null, max_dte: null, date: null };
    document.getElementById('btn-short').classList.toggle('active', term === 'SHORT');
    document.getElementById('btn-mid').classList.toggle('active',   term === 'MID');
    render();
}

function render() {
    renderMin();
    renderMax();
    renderDates();
    renderSummary();
    document.getElementById('scan-btn').disabled = !s.date;
}

function renderMin() {
    const opts = s.term === 'SHORT' ? SHORT_MIN : MID_MIN;
    document.getElementById('min-grid').innerHTML = opts.map(v =>
        `<button class="chip${s.min_dte === v ? ' active' : ''}"
                 onclick="pick('min_dte',${v})">${dteLabel(v)}</button>`
    ).join('');
}

function renderMax() {
    if (s.min_dte === null) {
        document.getElementById('max-grid').innerHTML =
            '<div class="placeholder" style="grid-column:span 2">Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼Ğ¸Ğ½. DTE</div>';
        return;
    }
    const opts = (s.term === 'SHORT' ? SHORT_MAX : MID_MAX).filter(v => v > s.min_dte);
    if (!opts.length) {
        document.getElementById('max-grid').innerHTML =
            '<div class="placeholder" style="grid-column:span 2">ĞĞµÑ‚ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ² â€” ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ÑŒÑ‚Ğµ Ğ¼Ğ¸Ğ½. DTE</div>';
        return;
    }
    document.getElementById('max-grid').innerHTML = opts.map(v =>
        `<button class="chip${s.max_dte === v ? ' active' : ''}"
                 onclick="pick('max_dte',${v})">${dteLabel(v)}</button>`
    ).join('');
}

function renderDates() {
    if (!s.max_dte) {
        document.getElementById('dates-grid').innerHTML =
            '<div class="placeholder" style="grid-column:span 2">Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼Ğ°ĞºÑ. DTE</div>';
        return;
    }
    const fridays = getFridays(s.min_dte, s.max_dte);
    if (!fridays.length) {
        document.getElementById('dates-grid').innerHTML =
            '<div class="placeholder" style="grid-column:span 2">ĞĞµÑ‚ Ğ¿ÑÑ‚Ğ½Ğ¸Ñ† Ğ² Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ</div>';
        return;
    }
    document.getElementById('dates-grid').innerHTML = fridays.map(d => {
        const iso  = isoDate(d);
        const day  = WDAYS[d.getDay()];
        const label = `${d.getDate()} ${MONTHS[d.getMonth()+1]}`;
        const dte   = Math.round((d - new Date().setHours(0,0,0,0)) / 86400000);
        return `
            <button class="chip date-chip${s.date === iso ? ' active' : ''}"
                    onclick="pick('date','${iso}')">
                <div class="date-day">${label}</div>
                <div class="date-sub">${day} Â· ${dte} Ğ´Ğ½.</div>
            </button>`;
    }).join('');
}

function renderSummary() {
    if (!s.date) { document.getElementById('summary').textContent = ''; return; }
    const termLabel = s.term === 'SHORT' ? 'Short Term' : 'Mid Term';
    document.getElementById('summary').textContent =
        `${termLabel} Â· DTE ${s.min_dte}â€“${s.max_dte} Â· Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ ${s.date}`;
}

// â”€â”€ Pick â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pick(field, val) {
    if (field === 'min_dte') {
        s.min_dte = val;
        s.max_dte = null;
        s.date    = null;
    } else if (field === 'max_dte') {
        s.max_dte = val;
        s.date    = null;
    } else {
        s.date = val;
    }
    render();
}

// â”€â”€ Send to bot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startScan() {
    if (!s.date) return;
    const payload = JSON.stringify({
        term:        s.term,
        min_dte:     s.min_dte,
        max_dte:     s.max_dte,
        target_date: s.date
    });
    if (tg) {
        tg.sendData(payload);
    } else {
        // fallback Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ
        alert('Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ: ' + payload);
    }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
render();
</script>
</body>
</html>
