<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Options Scanner</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg:           var(--tg-theme-bg-color,           #1c1c1e);
            --text:         var(--tg-theme-text-color,         #ffffff);
            --hint:         var(--tg-theme-hint-color,         #8e8e93);
            --btn:          var(--tg-theme-button-color,       #2481cc);
            --btn-text:     var(--tg-theme-button-text-color,  #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #2c2c2e);
            --sep:          rgba(255,255,255,0.08);
            --short-color:  #2481cc;
            --mid-color:    #34c759;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 16px 16px 24px;
            min-height: 100vh;
        }

        h2 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
            margin-bottom: 20px;
        }

        /* â”€â”€ Term block â”€â”€ */
        .term-block {
            background: var(--secondary-bg);
            border-radius: 16px;
            padding: 14px 14px 16px;
            margin-bottom: 12px;
        }

        .term-header {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .term-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 20px;
            margin-left: auto;
        }

        .term-badge.ready {
            background: rgba(52, 199, 89, 0.2);
            color: #34c759;
        }

        .term-badge.pending {
            background: rgba(255,255,255,0.08);
            color: var(--hint);
        }

        /* â”€â”€ Section â”€â”€ */
        .section { margin-bottom: 12px; }
        .section:last-child { margin-bottom: 0; }

        .section-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--hint);
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-bottom: 6px;
        }

        /* â”€â”€ Grid buttons â”€â”€ */
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .chip {
            padding: 9px 4px;
            border: 2px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            transition: border-color 0.15s, background 0.15s, color 0.15s;
            text-align: center;
            line-height: 1.3;
        }

        .chip.active-short {
            border-color: var(--short-color);
            background: var(--short-color);
            color: #fff;
        }

        .chip.active-mid {
            border-color: var(--mid-color);
            background: var(--mid-color);
            color: #fff;
        }

        /* â”€â”€ Date chips â”€â”€ */
        .date-chip .date-day { font-weight: 700; font-size: 14px; }
        .date-chip .date-sub { font-size: 11px; color: var(--hint); margin-top: 2px; }
        .date-chip.active-short .date-sub,
        .date-chip.active-mid  .date-sub { color: rgba(255,255,255,0.75); }

        /* â”€â”€ Placeholder â”€â”€ */
        .placeholder {
            font-size: 12px;
            color: var(--hint);
            padding: 10px 4px;
            grid-column: span 4;
            text-align: center;
        }

        /* â”€â”€ Divider â”€â”€ */
        .term-divider {
            height: 1px;
            background: var(--sep);
            margin: 4px 0 12px;
        }

        /* â”€â”€ Scan button â”€â”€ */
        #scan-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: var(--btn);
            color: var(--btn-text);
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            transition: opacity 0.15s;
        }

        #scan-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        /* â”€â”€ Summary bar â”€â”€ */
        #summary {
            font-size: 12px;
            color: var(--hint);
            margin-top: 10px;
            min-height: 16px;
            padding-left: 2px;
            line-height: 1.5;
        }
    </style>
</head>
<body>

<h2>âš™ï¸ ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</h2>

<!-- SHORT TERM -->
<div class="term-block">
    <div class="term-header">
        ğŸ“… Short Term
        <span class="term-badge pending" id="short-badge">Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾</span>
    </div>

    <div class="section">
        <div class="section-label">ĞœĞ¸Ğ½. DTE</div>
        <div id="short-min-grid" class="grid"></div>
    </div>

    <div class="section">
        <div class="section-label">ĞœĞ°ĞºÑ. DTE</div>
        <div id="short-max-grid" class="grid"></div>
    </div>

    <div class="section">
        <div class="section-label">Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ</div>
        <div id="short-dates-grid" class="grid grid-2"></div>
    </div>
</div>

<!-- MID TERM -->
<div class="term-block">
    <div class="term-header">
        ğŸ“† Mid Term
        <span class="term-badge pending" id="mid-badge">Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾</span>
    </div>

    <div class="section">
        <div class="section-label">ĞœĞ¸Ğ½. DTE</div>
        <div id="mid-min-grid" class="grid"></div>
    </div>

    <div class="section">
        <div class="section-label">ĞœĞ°ĞºÑ. DTE</div>
        <div id="mid-max-grid" class="grid"></div>
    </div>

    <div class="section">
        <div class="section-label">Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ</div>
        <div id="mid-dates-grid" class="grid grid-2"></div>
    </div>
</div>

<div id="summary"></div>
<button id="scan-btn" onclick="startScan()" disabled>ğŸ” Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</button>

<script>
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

// â”€â”€ Options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SHORT_MIN = [3, 5, 7, 10];
const SHORT_MAX = [5, 7, 10, 14];
const MID_MIN   = [14, 21, 30, 45];
const MID_MAX   = [21, 30, 45, 60];

const MONTHS = ['', 'ÑĞ½Ğ²', 'Ñ„ĞµĞ²', 'Ğ¼Ğ°Ñ€', 'Ğ°Ğ¿Ñ€', 'Ğ¼Ğ°Ğ¹', 'Ğ¸ÑĞ½',
                    'Ğ¸ÑĞ»', 'Ğ°Ğ²Ğ³', 'ÑĞµĞ½', 'Ğ¾ĞºÑ‚', 'Ğ½Ğ¾Ñ', 'Ğ´ĞµĞº'];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let s = {
    short: { min_dte: null, max_dte: null, date: null },
    mid:   { min_dte: null, max_dte: null, date: null }
};

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dteLabel(n) {
    if (n >= 11 && n <= 14) return `${n} Ğ´Ğ½.`;
    const r = n % 10;
    if (r === 1) return `${n} Ğ´ĞµĞ½ÑŒ`;
    if (r >= 2 && r <= 4) return `${n} Ğ´Ğ½Ñ`;
    return `${n} Ğ´Ğ½.`;
}

function getFridays(minDte, maxDte) {
    const today = new Date(); today.setHours(0,0,0,0);
    const cur   = new Date(today); cur.setDate(today.getDate() + minDte);
    const end   = new Date(today); end.setDate(today.getDate() + maxDte);
    while (cur.getDay() !== 5) cur.setDate(cur.getDate() + 1);
    const result = [];
    while (cur <= end) { result.push(new Date(cur)); cur.setDate(cur.getDate() + 7); }
    return result;
}

function isoDate(d) { return d.toISOString().split('T')[0]; }

function todayMs() { const d = new Date(); d.setHours(0,0,0,0); return d.getTime(); }

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
    renderTerm('short', SHORT_MIN, SHORT_MAX);
    renderTerm('mid',   MID_MIN,   MID_MAX);
    renderSummary();
    const hasShort = !!s.short.date;
    const hasMid   = !!s.mid.date;
    document.getElementById('scan-btn').disabled = !(hasShort || hasMid);
}

function renderTerm(term, minOpts, maxOpts) {
    const st   = s[term];
    const cls  = `active-${term}`;

    // Min DTE
    document.getElementById(`${term}-min-grid`).innerHTML = minOpts.map(v =>
        `<button class="chip${st.min_dte === v ? ' ' + cls : ''}"
                 onclick="pick('${term}','min_dte',${v})">${dteLabel(v)}</button>`
    ).join('');

    // Max DTE
    if (st.min_dte === null) {
        document.getElementById(`${term}-max-grid`).innerHTML =
            `<div class="placeholder">Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼Ğ¸Ğ½. DTE</div>`;
    } else {
        const opts = maxOpts.filter(v => v > st.min_dte);
        if (!opts.length) {
            document.getElementById(`${term}-max-grid`).innerHTML =
                `<div class="placeholder">ĞĞµÑ‚ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ²</div>`;
        } else {
            document.getElementById(`${term}-max-grid`).innerHTML = opts.map(v =>
                `<button class="chip${st.max_dte === v ? ' ' + cls : ''}"
                         onclick="pick('${term}','max_dte',${v})">${dteLabel(v)}</button>`
            ).join('');
        }
    }

    // Dates
    if (!st.max_dte) {
        document.getElementById(`${term}-dates-grid`).innerHTML =
            `<div class="placeholder" style="grid-column:span 2">Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼Ğ°ĞºÑ. DTE</div>`;
    } else {
        const fridays = getFridays(st.min_dte, st.max_dte);
        if (!fridays.length) {
            document.getElementById(`${term}-dates-grid`).innerHTML =
                `<div class="placeholder" style="grid-column:span 2">ĞĞµÑ‚ Ğ¿ÑÑ‚Ğ½Ğ¸Ñ† Ğ² Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ</div>`;
        } else {
            document.getElementById(`${term}-dates-grid`).innerHTML = fridays.map(d => {
                const iso   = isoDate(d);
                const label = `${d.getDate()} ${MONTHS[d.getMonth()+1]}`;
                const dte   = Math.round((d.getTime() - todayMs()) / 86400000);
                return `
                    <button class="chip date-chip${st.date === iso ? ' ' + cls : ''}"
                            onclick="pick('${term}','date','${iso}')">
                        <div class="date-day">${label}</div>
                        <div class="date-sub">${dte} Ğ´Ğ½.</div>
                    </button>`;
            }).join('');
        }
    }

    // Badge
    const badge = document.getElementById(`${term}-badge`);
    if (st.date) {
        badge.textContent = st.date.slice(5).replace('-', ' ').replace(/(\d+) (\d+)/, (_, m, d) =>
            `${d} ${MONTHS[parseInt(m)]}`);
        badge.className = 'term-badge ready';
    } else {
        badge.textContent = 'Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾';
        badge.className = 'term-badge pending';
    }
}

function renderSummary() {
    const parts = [];
    if (s.short.date) parts.push(`SHORT DTE ${s.short.min_dte}â€“${s.short.max_dte} Â· ${s.short.date}`);
    if (s.mid.date)   parts.push(`MID DTE ${s.mid.min_dte}â€“${s.mid.max_dte} Â· ${s.mid.date}`);
    document.getElementById('summary').textContent = parts.join('\n');
}

// â”€â”€ Pick â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pick(term, field, val) {
    if (field === 'min_dte') {
        s[term].min_dte = val;
        s[term].max_dte = null;
        s[term].date    = null;
    } else if (field === 'max_dte') {
        s[term].max_dte = val;
        s[term].date    = null;
    } else {
        s[term].date = val;
    }
    render();
}

// â”€â”€ Send to bot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startScan() {
    const payload = {};
    if (s.short.date) {
        payload.short = {
            min_dte:     s.short.min_dte,
            max_dte:     s.short.max_dte,
            target_date: s.short.date
        };
    }
    if (s.mid.date) {
        payload.mid = {
            min_dte:     s.mid.min_dte,
            max_dte:     s.mid.max_dte,
            target_date: s.mid.date
        };
    }
    if (tg) {
        tg.sendData(JSON.stringify(payload));
    } else {
        alert('Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ: ' + JSON.stringify(payload, null, 2));
    }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
render();
</script>
</body>
</html>
